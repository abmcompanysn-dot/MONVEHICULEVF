<!DOCTYPE html><html lang="fr"><head>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Détails, caractéristiques et galerie photo du véhicule. Contactez-nous pour un essai ou plus d'informations.">
    <title>Détail du Véhicule - MON VÉHICULE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Favicon -->
    <link rel="icon" href="https://i.postimg.cc/FhccT3BF/logo-mon-vehicule.jpg">

    <!-- PWA Manifest & Theme Color -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">

    <!-- Librairie pour le QR Code -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

    <style>
        .holographic-text {
            background: linear-gradient(45deg, #8b7355 0%, #a0926b 25%, #d4af37 50%, #a0926b 75%, #8b7355 100%);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: darkHolographicShine 5s ease-in-out infinite;
            font-weight: 900;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 500px; /* Taille adaptée pour ce formulaire */
            width: 95%;
            position: relative;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes darkHolographicShine {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        .ultra-luxury-btn {
            position: relative;
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 50%, #000000 100%);
            color: #d4af37;
            font-weight: 700;
            text-transform: uppercase;
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 50px;
            padding: 12px 32px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .ultra-luxury-btn:hover {
            transform: translateY(-2px);
            border-color: rgba(212, 175, 55, 0.5);
        }
        .ultra-luxury-btn-outline {
            background: transparent;
            color: #4a4a4a;
            font-weight: 700;
            text-transform: uppercase;
            border: 2px solid #d1d5db;
            border-radius: 50px;
            padding: 12px 32px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .ultra-luxury-btn-outline:hover {
            background: #f3f4f6;
            border-color: #4a4a4a;
        }
        /* Styles pour l'accordéon */
        .accordion-item {
            border-bottom: 1px solid #e5e7eb;
        }
        .accordion-header {
            cursor: pointer;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: #111827;
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
            background-color: #f9fafb;
            padding: 0 1rem;
        }
        .accordion-content.open {
            max-height: 1000px; /* Valeur suffisamment grande */
            padding: 1rem;
            transition: max-height 0.5s ease-in, padding 0.5s ease-in;
        }
        .accordion-arrow {
            transition: transform 0.3s ease;
        }
        .accordion-header.active .accordion-arrow {
            transform: rotate(180deg);
        }
        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px dashed #d1d5db;
        }
        @media (max-width: 768px) {
            #main-image-container {
                height: 60vw; /* Limite la hauteur de l'image sur mobile */
                max-height: 300px;
            }

            /* Supprimer l'effet de lueur sur les titres sur mobile */
            .holographic-text { text-shadow: none; filter: none; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation (simplifiée) -->
    <nav class="sticky top-0 w-full z-50 backdrop-blur-md bg-black/90">
        <div class="max-w-7xl mx-auto px-6">
            <div class="flex justify-between items-center h-16">
                <a href="index.html" class="flex items-center space-x-3">
                    <img src="https://i.postimg.cc/FhccT3BF/logo-mon-vehicule.jpg" alt="Logo MON VÉHICULE" class="w-10 h-10 rounded-full object-cover">
                    <span class="hidden sm:inline text-white text-xl font-bold">MON VÉHICULE</span>
                </a>
                <div class="flex items-center space-x-4">
                    <a href="voitures-occasion.html" class="flex items-center gap-3 text-white hover:text-yellow-400 transition-colors">
                        <div class="w-2 h-2 bg-yellow-400 rounded-full"></div>
                        Nos Occasions
                    </a>
                    <a href="index.html" title="Retour à l'accueil" class="bg-white/20 text-white hover:bg-white/30 rounded-full p-2 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Modale de Contact (copiée de index.html) -->
    <div id="contact-modal" class="modal">
        <div class="modal-content">
            <div class="p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="contact-modal-title" class="text-2xl font-bold text-gray-900">Contacter pour ce véhicule</h2>
                    <button onclick="closeContactModal()" class="text-gray-500 hover:text-gray-700 text-2xl">✕</button>
                </div>
                
                <form id="contact-form" onsubmit="submitContactForm(event)">
                    <!-- Champ caché pour stocker les infos du véhicule -->
                    <input type="hidden" id="vehicle-details-for-form" name="vehicle_details" value="">

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nom *</label>
                        <input type="text" name="name" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Téléphone *</label>
                        <input type="tel" name="phone" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" name="email" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500" placeholder="facultatif">
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Votre Message</label>
                        <textarea name="message" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500" placeholder="Bonjour, je suis intéressé(e) par ce véhicule..."></textarea>
                    </div>
                    
                    <button type="submit" class="ultra-luxury-btn w-full py-3 text-lg flex items-center justify-center gap-2">
                        Envoyer via WhatsApp
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Contenu principal -->
    <main id="vehicle-detail-container" class="py-12 md:py-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- Placeholder de chargement -->
            <p id="loading-placeholder" class="text-center text-gray-500">Chargement des détails du véhicule...</p>
        </div>
    </main>

    <!-- Section Partage QR Code (Mobile Uniquement) -->
    <section id="qr-share-section" class="md:hidden py-12 bg-white">
        <div class="max-w-7xl mx-auto px-6 text-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Partagez cette Opportunité</h2>
            <p class="text-gray-600 mb-6">Faites découvrir ce véhicule à vos contacts en scannant ce code.</p>
            <div class="flex flex-col items-center gap-6">
                <div id="page-qrcode" class="p-3 bg-white rounded-xl shadow-lg border">
                    <!-- Le QR code sera généré ici par JavaScript -->
                </div>
                <button onclick="shareVehicle()" class="ultra-luxury-btn w-full max-w-xs flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" /></svg>
                    Partager le lien
                </button>
            </div>
        </div>
    </section>

    <!-- Section "Véhicules Similaires" -->
    <section id="similar-vehicles-section" class="py-20 bg-gray-100 hidden">
        <div class="max-w-7xl mx-auto px-6">
            <h2 class="text-4xl font-bold text-center mb-12 holographic-text">Véhicules Similaires</h2>
            <div id="similar-vehicles-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Les cartes des véhicules similaires seront injectées ici -->
            </div>
        </div>
    </section>

    <footer class="bg-black text-white py-12 mt-20">
        <div class="max-w-7xl mx-auto px-6 text-center">
            <p class="text-gray-500">© 2024 MON VÉHICULE - Africa Business Manager Company SN - Tous droits réservés</p>
        </div>
    </footer>

    <script src="config.js"></script>
    <script>
        let currentVehicle = null; // Pour stocker les données du véhicule actuel

        /**
         * Enregistre un lead dans Google Sheets puis ouvre WhatsApp.
         * L'ouverture de WhatsApp est prioritaire pour éviter les blocages de pop-up.
         * @param {object} leadData - Les données du lead (type, name, phone, email, message, details).
         * @param {string} whatsappUrl - L'URL WhatsApp à ouvrir.
         */
        function logAndOpenWhatsApp(leadData, whatsappUrl) {
            // Ouvre WhatsApp immédiatement pour ne pas faire attendre l'utilisateur et éviter les bloqueurs de pop-up.
            window.open(whatsappUrl, '_blank');

            // Envoie les données en arrière-plan.
            fetch(GAS_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(leadData)
            })
            .then(() => console.log("✅ Lead envoyé en arrière-plan."))
            .catch(error => console.error("🔥 Erreur lors de l'envoi du lead en arrière-plan:", error));
        }

        async function loadVehicleDetails() {
            const container = document.getElementById('vehicle-detail-container');
            const loadingPlaceholder = document.getElementById('loading-placeholder');
            const params = new URLSearchParams(window.location.search);
            const vehicleId = params.get('id');

            if (!vehicleId) {
                container.innerHTML = '<p class="text-center text-red-500">Aucun véhicule sélectionné.</p>';
                return;
            }

            try {
                // Utilise le cache pour récupérer tous les véhicules, puis trouve celui qui nous intéresse
                const allVehicles = await fetchWithCache('vehiclesCache', GAS_URL);
                const vehicle = allVehicles.find(v => v.id === vehicleId);

                if (!vehicle) {
                    throw new Error("Véhicule non trouvé.");
                }

                currentVehicle = vehicle; // Stocker le véhicule pour d'autres fonctions
                document.title = `${vehicle.marque} ${vehicle.modele} - MON VÉHICULE`;

                // Logique pour le badge de provenance
                let provenanceBadge = '';
                if (vehicle.provenance === 'MON VÉHICULE') {
                    provenanceBadge = `<div class="inline-flex items-center gap-2 bg-blue-100 text-blue-800 text-sm font-semibold px-3 py-1 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                        Garanti MON VÉHICULE
                    </div>`;
                } else if (vehicle.provenance === 'Partenaire Vérifié') {
                    provenanceBadge = `<div class="inline-flex items-center gap-2 bg-green-100 text-green-800 text-sm font-semibold px-3 py-1 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zM12 12a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /><path d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" /></svg>
                        Vendeur Partenaire Vérifié
                    </div>`;
                }

                // --- Fonctions pour l'affichage conditionnel ---
                const renderDetailItem = (label, value) => {
                    return value ? `<div class="detail-item">
                                        <span class="text-gray-600">${label}</span>
                                        <span class="font-semibold text-gray-800 text-right">${value}</span>
                                    </div>` : '';
                };

                const renderAccordionSection = (title, icon, content) => {
                    if (!content.trim()) return ''; // Ne pas afficher la section si elle est vide
                    return `
                        <div class="accordion-item">
                            <div class="accordion-header">
                                <span class="flex items-center gap-3">${icon} ${title}</span>
                                <span class="accordion-arrow">▼</span>
                            </div>
                            <div class="accordion-content">
                                <div class="space-y-2">${content}</div>
                            </div>
                        </div>
                    `;
                };

                // --- Construction des contenus pour les accordéons ---
                const identityContent = `
                    ${renderDetailItem('Immatriculation', vehicle.immatriculation)}
                    ${renderDetailItem('N° de Châssis (VIN)', vehicle.vin)}
                    ${renderDetailItem('Propriétaires précédents', vehicle.nb_proprietaires)}
                    ${renderDetailItem('Historique entretiens', vehicle.historique_entretien)}
                    ${renderDetailItem('Accidents / Réparations', vehicle.accidents)}
                `;
                const techContent = `
                    ${renderDetailItem('État Moteur', vehicle.etat_moteur)}
                    ${renderDetailItem('État des Freins', vehicle.etat_freins)}
                    ${renderDetailItem('État Pneus', vehicle.etat_pneus)}
                    ${renderDetailItem('État Boîte de vitesses', vehicle.etat_boite)}
                `;
                const visualContent = `
                    ${renderDetailItem('État Carrosserie', vehicle.etat_carrosserie)}
                    ${renderDetailItem('État Intérieur', vehicle.etat_interieur)}
                    ${renderDetailItem('Contrôle Technique', vehicle.doc_controle_technique)}
                    ${renderDetailItem('Garantie', vehicle.garantie)}
                `;

                // --- Icônes SVG pour les accordéons ---
                const identityIcon = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 012-2h2a2 2 0 012 2v1m-6 0h6" />
                    </svg>`;
                const techIcon = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                    </svg>`;
                const visualIcon = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>`;

                loadingPlaceholder.remove(); // Supprimer le message de chargement
                container.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">
                        <!-- Galerie d'images -->
                        <div class="space-y-4" id="gallery-container">
                            <div id="main-image-container" class="bg-gray-200 rounded-2xl overflow-hidden shadow-2xl">
                                <img id="main-image" src="${vehicle.image}" alt="Image principale de ${vehicle.marque} ${vehicle.modele}" class="w-full h-full object-cover transition-all duration-300">
                            </div>
                            <div id="thumbnail-gallery" class="flex gap-3 overflow-x-auto p-2">
                                ${vehicle.galerie && vehicle.galerie.length > 0 ? vehicle.galerie.map(imgUrl => `
                                    <img src="${imgUrl}" alt="Miniature" class="w-24 h-24 object-cover rounded-lg cursor-pointer border-2 border-transparent hover:border-yellow-500 transition-all" onclick="changeMainImage('${imgUrl}')">
                                `).join('') : ""}
                            </div>
                        </div>

                        <!-- Informations -->
                        <div>
                            <div class="mb-4">${provenanceBadge}</div>
                            <h1 class="text-4xl lg:text-5xl font-bold text-gray-900 mb-2">${vehicle.marque} ${vehicle.modele}</h1>
                            <p class="text-3xl font-black text-yellow-600 mb-8">${vehicle.prix}</p>
                            
                            <div class="border-t border-b border-gray-200 py-6 mb-8">
                                <h3 class="text-xl font-bold mb-4 text-gray-800">Caractéristiques Clés</h3>
                                <div class="grid grid-cols-2 gap-x-6 gap-y-4 text-lg">
                                    <div class="flex items-center gap-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                        <div><strong class="font-semibold">Année:</strong> ${vehicle.annee}</div>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16V8a4 4 0 10-8 0v8m-3 0h11" /></svg>
                                        <div><strong class="font-semibold">Km:</strong> ${vehicle.kilometrage}</div>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                                        <div><strong class="font-semibold">Carburant:</strong> ${vehicle.carburant}</div>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924-1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                        <div><strong class="font-semibold">Boîte:</strong> ${vehicle.transmission}</div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-8">
                                <h3 class="text-xl font-bold mb-2 text-gray-800">Description</h3>
                                <p class="text-gray-700 leading-relaxed">${vehicle.description}</p>
                            </div>

                            <!-- ACCORDÉON DE DÉTAILS -->
                            <div class="border rounded-lg overflow-hidden mb-8">
                                ${renderAccordionSection('Identité & Historique', identityIcon, identityContent)}
                                ${renderAccordionSection('État Technique', techIcon, techContent)}
                                ${renderAccordionSection('État Visuel & Documents', visualIcon, visualContent)}
                            </div>

                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <button onclick="openContactForVehicle('${vehicle.marque}', '${vehicle.modele}')" class="ultra-luxury-btn w-full text-center py-4 text-lg flex items-center justify-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>
                                    Contacter
                                </button>
                                <button onclick="shareVehicle()" class="ultra-luxury-btn-outline w-full text-center py-4 text-lg flex items-center justify-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" /></svg>
                                    Partager
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                // Activer la logique de l'accordéon
                document.querySelectorAll('.accordion-header').forEach(header => {
                    header.addEventListener('click', () => {
                        const content = header.nextElementSibling;
                        header.classList.toggle('active');
                        content.classList.toggle('open');
                    });
                });
                // Ouvrir la première section par défaut si elle existe
                const firstAccordionHeader = document.querySelector('.accordion-header');
                if(firstAccordionHeader) firstAccordionHeader.click();

                // Générer le QR code pour la section de partage mobile
                const qrContainer = document.getElementById('page-qrcode');
                if(qrContainer) new QRCode(qrContainer, { text: window.location.href, width: 160, height: 160 });

                // Charger et afficher les véhicules similaires
                loadSimilarVehicles(allVehicles, vehicle.marque, vehicle.id);

            } catch (error) {
                console.error("Erreur:", error);
                container.innerHTML = `<p class="text-center text-red-500">Impossible de charger les détails du véhicule.</p>`;
            }
        }

        function changeMainImage(url) {
            const mainImage = document.getElementById('main-image');

            // Éviter de relancer l'animation si on clique sur la même image
            if (mainImage.src === url) return;

            // 1. Appliquer un effet de fondu sortant
            mainImage.style.opacity = 0;

            // 2. Attendre la fin de la transition pour changer l'image et la faire réapparaître
            setTimeout(() => {
                mainImage.src = url;
                mainImage.style.opacity = 1;
            }, 300); // Doit correspondre à la durée de la transition (duration-300)
        }

        function loadSimilarVehicles(allVehicles, currentBrand, currentId) {
            const similarVehicles = allVehicles.filter(v => v.marque === currentBrand && v.id !== currentId);

            const section = document.getElementById('similar-vehicles-section');
            const grid = document.getElementById('similar-vehicles-grid');

            if (similarVehicles.length > 0) {
                grid.innerHTML = '';
                similarVehicles.slice(0, 3).forEach(vehicle => { // Affiche 3 véhicules max
                    const card = document.createElement('div');
                    card.className = 'border rounded-2xl overflow-hidden shadow-lg transition-transform hover:-translate-y-2 group bg-white';
                    card.innerHTML = `
                        <a href="detail-vehicule.html?id=${vehicle.id}" class="block">
                            <div class="relative">
                                <img src="${vehicle.image}" alt="${vehicle.marque} ${vehicle.modele}" class="w-full h-56 object-cover">
                                <div class="absolute top-2 right-2 bg-black/50 text-white text-sm px-3 py-1 rounded-full">${vehicle.kilometrage}</div>
                            </div>
                            <div class="p-6">
                                <h3 class="text-2xl font-bold text-gray-900 truncate">${vehicle.marque} ${vehicle.modele}</h3>
                                <p class="text-gray-600 mb-4">${vehicle.annee}</p>
                                <p class="text-3xl font-black text-yellow-600">${vehicle.prix}</p>
                            </div>
                        </a>
                    `;
                    grid.appendChild(card);
                });
                section.classList.remove('hidden');
            }
        }

        /**
         * Partage le véhicule en utilisant l'API Web Share.
         * Tente de partager l'image, le titre, le texte et l'URL.
         */
        async function shareVehicle() {
            if (!currentVehicle) {
                alert("Les détails du véhicule ne sont pas encore chargés.");
                return;
            }

            const shareData = {
                title: `MON VÉHICULE : ${currentVehicle.marque} ${currentVehicle.modele}`,
                text: `Découvrez ce superbe ${currentVehicle.marque} ${currentVehicle.modele} de ${currentVehicle.annee} chez MON VÉHICULE.\n\nPrix : ${currentVehicle.prix}\n${currentVehicle.description}`,
                url: window.location.href,
            };

            // Tenter le partage natif avec l'image générée
            if (navigator.share) {
                try {
                    alert("Préparation de l'image de partage, veuillez patienter...");
                    const shareFile = await generateShareImage(currentVehicle);

                    if (navigator.canShare && navigator.canShare({ files: [shareFile] })) {
                        await navigator.share({
                            files: [shareFile],
                            title: shareData.title,
                            text: shareData.text, // Le texte sera utilisé par certaines apps, l'image par d'autres
                            url: shareData.url,
                        });
                    } else {
                        // Si le partage de fichier n'est pas supporté, partager le texte et le lien
                        await navigator.share(shareData);
                    }
                } catch (error) {
                    console.error('Erreur de partage:', error);
                    // Fallback en cas d'erreur (ex: partage annulé)
                    alert("Le partage a été annulé ou a échoué.");
                }
            } else {
                // Fallback pour les navigateurs qui ne supportent pas du tout le partage
                alert("Le partage n'est pas supporté sur votre navigateur. Vous pouvez copier le lien manuellement.");
            }
        }

        /**
         * Génère une image de partage personnalisée sur un canvas.
         * @param {object} vehicle - L'objet contenant les détails du véhicule.
         * @returns {Promise<File>} - Une promesse qui résout avec le fichier image généré.
         */
        async function generateShareImage(vehicle) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const width = 1200;
            const height = 630;
            canvas.width = width;
            canvas.height = height;

            // --- Arrière-plan et bordure générale ---
            ctx.fillStyle = '#1a1a1a';
            ctx.fillRect(0, 0, width, height);
            ctx.strokeStyle = '#d4af37';
            ctx.lineWidth = 2;
            ctx.strokeRect(1, 1, width - 2, height - 2);

            // --- Charger l'image du véhicule pour la dessiner sans la déformer ---
            const imageAreaWidth = 780;
            const imageAreaHeight = height - 40;
            const padding = 20;

            try {
                const vehicleImg = new Image();
                vehicleImg.crossOrigin = "anonymous";
                vehicleImg.src = vehicle.image;
                await new Promise((resolve, reject) => { vehicleImg.onload = resolve; vehicleImg.onerror = reject; });

                const imgRatio = vehicleImg.width / vehicleImg.height;
                const areaRatio = imageAreaWidth / imageAreaHeight;
                let drawWidth, drawHeight, drawX, drawY;

                // Calcul pour "fit" l'image dans la zone, en conservant son ratio
                if (imgRatio > areaRatio) {
                    drawWidth = imageAreaWidth;
                    drawHeight = drawWidth / imgRatio;
                } else {
                    drawHeight = imageAreaHeight;
                    drawWidth = drawHeight * imgRatio;
                }
                drawX = padding + (imageAreaWidth - drawWidth) / 2;
                drawY = padding + (imageAreaHeight - drawHeight) / 2;

                // Dessiner l'image
                ctx.drawImage(vehicleImg, drawX, drawY, drawWidth, drawHeight);

            } catch (e) {
                console.error("Impossible de charger l'image du véhicule pour le canvas", e);
            }

            // --- Zone de texte à droite ---
            const textX = 820;
            ctx.fillStyle = '#fff';
            ctx.textAlign = 'left';

            // --- Logo et Nom de la marque ---
            const logoImg = new Image();
            logoImg.crossOrigin = "anonymous";
            logoImg.src = 'https://i.postimg.cc/FhccT3BF/logo-mon-vehicule.jpg';
            await new Promise(resolve => { logoImg.onload = resolve; });
            ctx.drawImage(logoImg, textX, 40, 70, 70);
            ctx.font = 'italic 32px "Times New Roman", serif';
            ctx.fillStyle = '#d4af37';
            ctx.fillText("MON VÉHICULE", textX + 85, 85);

            // --- Titre du véhicule ---
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 42px sans-serif';
            ctx.fillText(vehicle.marque, textX, 170);
            ctx.font = 'bold 52px sans-serif';
            ctx.fillText(vehicle.modele, textX, 225);

            // --- Détails ---
            ctx.font = '28px sans-serif';
            ctx.fillStyle = '#ccc';
            ctx.fillText(`${vehicle.annee} • ${vehicle.kilometrage}`, textX, 270);
            ctx.fillStyle = '#d4af37';
            ctx.font = 'bold 44px sans-serif';
            ctx.fillText(vehicle.prix, textX, 340);

            // --- Contenu dynamique : QR Code sur Desktop, Infos sur Mobile ---
            const isMobile = window.innerWidth < 768;

            if (isMobile) {
                // Version pour mobile : pas de QR code, mais des infos directes
                ctx.textAlign = 'center';
                const centerX = textX + (width - textX) / 2;

                ctx.font = 'italic 28px "Times New Roman", serif';
                ctx.fillStyle = '#d4af37';
                ctx.fillText("Une opportunité à saisir !", centerX, height - 150);

                ctx.font = 'bold 32px sans-serif';
                ctx.fillStyle = '#fff';
                ctx.fillText("Contactez-nous au", centerX, height - 100);
                ctx.fillText("+221 76 904 79 99", centerX, height - 60);
            } else {
                // Version pour desktop : avec QR code, numéro et slogan
                const qrContainer = document.createElement('div');
                new QRCode(qrContainer, { text: window.location.href, width: 120, height: 120 });
                await new Promise(resolve => setTimeout(resolve, 200));
                const qrImg = qrContainer.querySelector('img');
                if (qrImg) ctx.drawImage(qrImg, textX, height - 180, 120, 120);
                
                ctx.textAlign = 'left';
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 24px sans-serif';
                ctx.fillText("Contact : +221 76 904 79 99", textX + 135, height - 140);
                ctx.font = '20px sans-serif';
                ctx.fillStyle = '#ccc';
                ctx.fillText("Scannez pour les détails", textX + 135, height - 110);
            }
            ctx.font = 'italic 24px "Times New Roman", serif';
            ctx.fillStyle = '#d4af37';
            ctx.textAlign = 'center';
            ctx.fillText("L'Excellence Automobile Africaine", textX + (width - textX) / 2, height - 35);

            // --- Convertir le canvas en fichier ---
            return new Promise(resolve => {
                canvas.toBlob(blob => {
                    const file = new File([blob], `${vehicle.id}-share.png`, { type: 'image/png' });
                    resolve(file);
                }, 'image/png');
            });
        }

        // --- Fonctions pour la modale de contact ---

        function openContactForVehicle(marque, modele) {
            const modal = document.getElementById('contact-modal');
            const title = document.getElementById('contact-modal-title');
            const hiddenInput = document.getElementById('vehicle-details-for-form');

            title.innerText = `Contacter pour : ${marque} ${modele}`;
            hiddenInput.value = `${marque} ${modele}`; // Stocke les détails pour la soumission

            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeContactModal() {
            document.getElementById('contact-modal').classList.remove('show');
            document.body.style.overflow = 'auto';
        }

        function submitContactForm(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const name = formData.get('name');
            const phone = formData.get('phone');
            const email = formData.get('email');
            const userMessage = formData.get('message');
            const vehicleDetails = formData.get('vehicle_details');
            
            // Récupérer la marque et le modèle depuis les données du véhicule actuel
            const marque = currentVehicle ? currentVehicle.marque : 'N/A';
            const modele = currentVehicle ? currentVehicle.modele : 'N/A';

            let whatsappMessage = `*Bonjour MON VÉHICULE !*

Je suis intéressé(e) par le modèle :

  *Marque :* ${marque}
  *Modèle :* ${modele}

*Mes coordonnées :*
  *Nom :* ${name}
  *Téléphone :* ${phone}`

            if (email) {
                whatsappMessage += `\n  *Email :* ${email}`;
            }

            if (userMessage) {
                whatsappMessage += `\n\n*Message supplémentaire :*\n${userMessage}`;
            }

            const encodedMessage = encodeURIComponent(whatsappMessage);
            const whatsappNumber = "221769047999";
            const whatsappURL = `https://wa.me/${whatsappNumber}?text=${encodedMessage}`;

            const leadData = {
                type: 'Contact Véhicule Occasion',
                name: name,
                phone: phone,
                email: email || '',
                details: `Véhicule: ${vehicleDetails}`,
                message: userMessage || 'Pas de message supplémentaire.'
            };

            logAndOpenWhatsApp(leadData, whatsappURL);

            event.target.reset();
            closeContactModal();
            alert(`Merci ${name} ! WhatsApp va s'ouvrir avec votre message.`);
        }

        document.addEventListener('DOMContentLoaded', loadVehicleDetails);

        // Enregistrement du Service Worker pour la PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('✅ Service Worker enregistré avec succès:', registration.scope);
                    })
                    .catch(error => {
                        console.log('🔥 Échec de l\'enregistrement du Service Worker:', error);
                    });
            });
        }
    </script>
</body>
</html>
                    